/**
 * Core Philosophy: This ruleset implements a hybrid security model tailored for the Ouro Gr√°fica marketplace.
 * Publicly accessible data, such as the product and category catalogs, is readable by anyone, ensuring a smooth browsing experience.
 * All user-specific data, including profiles and order histories, is strictly private and governed by a user-ownership model, where users can only access their own information.
 * An admin role is implemented via Firebase Auth Custom Claims to allow privileged access for store management.
 *
 * Data Structure: The data is organized into logical, top-level collections for public catalogs (`products`, `categories`) and transactional data (`orders_items`).
 * All private user information is hierarchically nested under the `/users/{userId}` path, creating a clear and secure boundary for personal data.
 *
 * Key Security Decisions:
 * - Admin Access: Users with a custom claim `isAdmin: true` on their authentication token have elevated privileges. This is checked by the isAdmin() function.
 * - User Enumeration Disabled for Non-Admins: Listing users from the top-level `/users` collection is forbidden for regular users to protect privacy.
 * - Public Catalogs: `products` and `categories` are world-readable. Write operations are restricted to admins.
 * - Strict Ownership: All documents within `/users/{userId}` are accessible only to the authenticated user whose UID matches the `userId` in the path, or by an admin.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Validates if the requesting user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the currently authenticated user has admin privileges.
     * It does this by checking for an `isAdmin` custom claim on the user's auth token.
     * This is faster and more secure than reading a document.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.isAdmin == true;
    }

    /**
     * Validates that an incoming field is identical to the existing one.
     * Used to enforce the immutability of critical relational fields like IDs.
     */
    function isImmutable(field) {
      return request.resource.data[field] == resource.data[field];
    }


    //-------------------------------------------------------------------------
    // Collection Rules
    //-------------------------------------------------------------------------

    /**
     * @description Products are public for browsing but can only be modified by admins.
     * @path /products/{productId}
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();

      /**
       * @description Reviews for a product. Publicly readable. Users can write/edit/delete their own reviews.
       * @path /products/{productId}/reviews/{reviewId}
       */
      match /reviews/{reviewId} {
        allow get, list: if true;
        // User must be signed in and be the author of the review to create.
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        // User can only update or delete their own review.
        allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
      }
    }

    /**
     * @description Categories are public for browsing but can only be modified by admins.
     * @path /categories/{categoryId}
     */
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description A user's profile document. Owners can manage their data. Admins have read access.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // Owners or admins can read a profile.
      allow get: if isOwner(userId) || isAdmin();
      // Only admins can list all users.
      allow list: if isAdmin();
      // Only the owner can create their own profile.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      // Only the owner can update their own profile.
      allow update: if isOwner(userId) && isImmutable('id');
      // Only the owner can delete their own profile.
      allow delete: if isOwner(userId);

      /**
       * @description A user's orders. Only the owner or an admin can access them.
       * @path /users/{userId}/orders/{orderId}
       */
      match /orders/{orderId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId) && request.resource.data.customerId == userId;
        allow update: if (isOwner(userId) || isAdmin()) && isImmutable('customerId');
        allow delete: if isOwner(userId) || isAdmin();
      }

      /**
       * @description A user's favorite products (wishlist).
       * @path /users/{userId}/favorites/{productId}
       */
      match /favorites/{productId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.productId == productId;
        allow delete: if isOwner(userId);
        allow update: if false; // Favorites are either there or not, no updates needed.
      }
    }

    /**
     * @description Individual items within an order. Access is granted to the owner or an admin.
     * @path /orders_items/{orderItemId}
     */
    match /orders_items/{orderItemId} {
      allow get: if isOwner(resource.data.customerId) || isAdmin();
      // Allow admins to list all order items for the dashboard.
      allow list: if isAdmin();
      allow create: if isOwner(request.resource.data.customerId);
      allow update: if (isOwner(resource.data.customerId) || isAdmin()) && isImmutable('customerId');
      allow delete: if isOwner(resource.data.customerId) || isAdmin();
    }
  }
}
    