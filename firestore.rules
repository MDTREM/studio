/**
 * Core Philosophy: This ruleset implements a hybrid security model tailored for the Ouro Gr√°fica marketplace.
 * Publicly accessible data, such as the product and category catalogs, is readable by anyone, ensuring a smooth browsing experience.
 * All user-specific data, including profiles and order histories, is strictly private and governed by a user-ownership model, where users can only access their own information.
 * An admin role is implemented to allow privileged access for store management.
 *
 * Data Structure: The data is organized into logical, top-level collections for public catalogs (`products`, `categories`) and transactional data (`orders_items`).
 * All private user information is hierarchically nested under the `/users/{userId}` path, creating a clear and secure boundary for personal data.
 *
 * Key Security Decisions:
 * - Admin Access: Users with a custom claim or a specific field (`isAdmin: true`) in their profile document have elevated privileges.
 * - User Enumeration Disabled for Non-Admins: Listing users from the top-level `/users` collection is forbidden for regular users to protect privacy.
 * - Public Catalogs: `products` and `categories` are world-readable. Write operations are restricted to admins.
 * - Strict Ownership: All documents within `/users/{userId}` are accessible only to the authenticated user whose UID matches the `userId` in the path, or by an admin.
 *
 * Denormalization for Authorization: To ensure fast and secure access control, this ruleset relies on denormalization. For example, the `customerId` (the user's UID) is stored on each `orders_items` document. This avoids slow cross-collection `get()` calls and allows for direct ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Validates if the requesting user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the currently authenticated user has admin privileges.
     * It does this by checking for an `isAdmin` flag in the user's own profile document.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    /**
     * Validates that an incoming field is identical to the existing one.
     * Used to enforce the immutability of critical relational fields like IDs.
     */
    function isImmutable(field) {
      return request.resource.data[field] == resource.data[field];
    }


    //-------------------------------------------------------------------------
    // Collection Rules
    //-------------------------------------------------------------------------

    /**
     * @description Products are public for browsing but can only be modified by admins.
     * @path /products/{productId}
     * @allow (get, list) Any user, signed in or not, can view products.
     * @allow (create, update, delete) Only admins can manage the product catalog.
     * @principle Public read access for catalog, with writes restricted to trusted roles.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Categories are public for browsing but can only be modified by admins.
     * @path /categories/{categoryId}
     * @allow (get, list) Any user, signed in or not, can view a category.
     * @allow (create, update, delete) Only admins can manage categories.
     * @principle Public read access for catalog, with writes restricted to trusted roles.
     */
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description A user's profile document. The owner can manage their own data. Admins have read-only access.
     * @path /users/{userId}
     * @allow (get) Owner or an admin can read the profile.
     * @allow (list) Regular users cannot list all users. Admins can.
     * @allow (create, update, delete) Only the owner can modify their profile.
     * @principle Enforces data privacy while allowing for administrative oversight.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && isImmutable('id');
      allow delete: if isOwner(userId);

      /**
       * @description A user's orders. Only the owner or an admin can access them.
       * @path /users/{userId}/orders/{orderId}
       * @allow (get, list) Owner or admin can view orders.
       * @allow (create, update, delete) Only the owner can manage their orders.
       * @principle Path-based security inherited from parent, plus admin override.
       */
      match /orders/{orderId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId) && request.resource.data.customerId == userId;
        allow update: if (isOwner(userId) || isAdmin()) && isImmutable('customerId');
        allow delete: if isOwner(userId) || isAdmin();
      }

      /**
       * @description A user's favorite products (wishlist).
       * @path /users/{userId}/favorites/{productId}
       * @allow (get, list, create, delete) Only the user can manage their own favorites. Admins do not need access here.
       * @principle Strict path-based security for personal, non-critical data.
       */
      match /favorites/{productId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.productId == productId;
        allow delete: if isOwner(userId);
        allow update: if false; // Favorites are either there or not, no updates needed.
      }
    }

    /**
     * @description Individual items within an order. Access is granted to the owner or an admin.
     * @path /orders_items/{orderItemId}
     * @allow (get) The user who owns the order item or an admin can read it.
     * @allow (list) Admins can list all order items for the admin dashboard.
     * @allow (create) The owner can create an order item.
     * @allow (update, delete) The owner or an admin can modify or delete the order item.
     * @principle Relies on denormalized data (`customerId`) for secure, high-performance checks with an admin override.
     */
    match /orders_items/{orderItemId} {
      allow get: if isOwner(resource.data.customerId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(request.resource.data.customerId);
      allow update: if (isOwner(resource.data.customerId) || isAdmin()) && isImmutable('customerId');
      allow delete: if isOwner(resource.data.customerId) || isAdmin();
    }
  }
}
